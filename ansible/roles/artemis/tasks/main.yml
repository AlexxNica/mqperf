---
- name: Install libaio module (used for persistence)
  package:
    name:   libaio
    state:  installed
    
- name: Create artemis user
  user:
    name: "{{ artemis_username }}"
    shell: /bin/bash    

- name: Download artemis
  get_url:
    dest: "{{ artemis_download_dest }}"
    url:  "{{ artemis_download_url }}"
    
- name: Unpack archive
  unarchive:
    copy:    no
    dest:    /opt
    src:     "{{ artemis_download_dest }}"
    creates: /opt/{{ artemis_name }}
    owner:   "{{ artemis_username }}"

- name: Create user-friendly link
  file:
    state: link
    src: /opt/{{ artemis_name }}
    dest: /opt/artemis

- set_fact: artemis_broker_master="{{ groups['artemis'][0] }}"
- set_fact: artemis_broker_slave_1="{{ groups['artemis'][1] }}"
- set_fact: artemis_broker_slave_2="{{ groups['artemis'][2] }}"

- name: Set hostname master
  run_once: true
  delegate_to: "{{ item }}"
  hostname:
    name: "artemis_broker_master"
  with_items:
    - "{{ artemis_broker_master }}"

- name: Set hostname slave 1
  run_once: true
  delegate_to: "{{ item }}"
  hostname:
    name: "artemis_broker_slave_1"
  with_items:
    - "{{ artemis_broker_slave_1 }}"

- name: Set hostname slave 2
  run_once: true
  delegate_to: "{{ item }}"
  hostname:
    name: "artemis_broker_slave_2"
  with_items:
    - "{{ artemis_broker_slave_2 }}"

- name: Create master broker
  run_once: true
  delegate_to: "{{ item }}"
  command: |
    /opt/{{ artemis_name }}/bin/artemis 
    create 
    /opt/{{ artemis_name }}-broker/ 
    --force 
    --user artemis 
    --password artemis 
    --allow-anonymous 
    --clustered 
    --host "{{ hostvars[artemis_broker_master].ec2_private_ip_address }}" 
    --cluster-user artemis 
    --cluster-password artemis
  with_items:
    - "{{ artemis_broker_master }}"
    
- name: Create slave 1 broker
  run_once: true
  delegate_to: "{{ item }}"
  command: |
    /opt/{{ artemis_name }}/bin/artemis 
    create 
    /opt/{{ artemis_name }}-broker/ 
    --force 
    --user artemis 
    --password artemis 
    --allow-anonymous 
    --clustered 
    --host "{{ hostvars[artemis_broker_slave_1].ec2_private_ip_address }}" 
    --cluster-user artemis 
    --cluster-password artemis
  with_items:
    - "{{ artemis_broker_slave_1 }}"

- name: Create slave 2 broker
  run_once: true
  delegate_to: "{{ item }}"
  command: |
    /opt/{{ artemis_name }}/bin/artemis 
    create 
    /opt/{{ artemis_name }}-broker/ 
    --force 
    --user artemis 
    --password artemis 
    --allow-anonymous 
    --clustered 
    --host "{{ hostvars[artemis_broker_slave_2].ec2_private_ip_address }}" 
    --cluster-user artemis 
    --cluster-password artemis
  with_items:
    - "{{ artemis_broker_slave_2 }}"
